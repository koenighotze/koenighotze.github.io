A/B testing with AWS Lambda


- What is a version?
$ aws lambda get-function --function-name HelloWorld
{
    "Configuration": {
        "FunctionName": "HelloWorld",
        "FunctionArn": "arn:aws:lambda:eu-central-1:604370441254:function:HelloWorld",
        "Runtime": "nodejs6.10",
        "Role": "arn:aws:iam::604370441254:role/basic-lambda-logging",
        "Handler": "index.helloworld",
        "CodeSize": 329,
        "Description": "",
        "Timeout": 3,
        "MemorySize": 128,
        "LastModified": "2017-11-16T16:27:38.108+0000",
        "CodeSha256": "ii2AmY6dB/YyUcQsSJFoWuEocq36gtpbbaTpcxMGJyc=",
        "Version": "$LATEST",
        "TracingConfig": {
            "Mode": "PassThrough"
        }
    },
    "Code": {
        "RepositoryType": "S3",
        "Location": "https://awslambda-eu-cent-1-tasks.s3.eu-central-1.amazonaws.com/snapshots/604370441254/HelloWorld-772d1339-57ec-40d9-ba3c-3ab3b58bf76c?versionId=wbMYON4C_fZJucmFn_rchI0NY5C.BeH4&X-Amz-Security-Token=FQoDYXdzEO7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaDAdJDFCIzu3uQAO78iK9A0YDz5LUWqbYwbOudK3omTGb4DpOsOi5p2OGmcg7oMiEAVx70Bzjz0Cc0cuaYBMzestTXXHWUCugmEKp2e7rr8bY6sPUH9gPsmKK5J%2FmLNBLnKqv2bkjbhXtciLLoislJUhdhOB2cJeozXzj6PHS4AsDdnd1lF%2B7Uqbpo%2Fl%2F%2B0GOn6kGUCGFyBrz1JIX55DnndY0QTYr0%2BeMT6au%2BivzWKwQ35kYTDBRGH4fqLgnL1r7YY%2Fe4TBl2tSuEoyzmWlGALfNl3S768meNiTTfi1ORF2MtpSSFCgci31Pkrka57o1eAv6%2BLY6CgjDp%2FvFrJ47IYiMR2cLNGCCi%2BeKWpJbwvd8k6y3g7Y%2FVTDO5rJ9a44hAH1CLOQ418FkMfqJn9WENPnqlzE0KbiEuAo4flmp%2Fl4zr7TWEvmOBo7t1ml8xRgJMAuDrla3O2gX9oJ6o%2B3XV7qzo4ViEy7croL0LAtTdxnQ8wtDVjDp7IkIvPg%2Fctedom9cA8ROv3%2Bk%2FLI%2BExzYWrN2xnnaJ2PH38trHkPQHGS%2F2cRgIk04oUD9RDFbG9MJvYBNkgVtt0oe705H%2B%2F20vqZIlEm06VlVxTQ%2B8QEokaiF0QU%3D&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20171201T132421Z&X-Amz-SignedHeaders=host&X-Amz-Expires=599&X-Amz-Credential=ASIAI7QQ5TA44VUWZBLA%2F20171201%2Feu-central-1%2Fs3%2Faws4_request&X-Amz-Signature=36bd5c547c577138fee35acee834cff7e96754bd397da3c6d8bdb3ad150ce33c"
    }
}



$ aws lambda list-versions-by-function --function-name HelloWorld
{
    "Versions": [
        {
            "FunctionName": "HelloWorld",
            "FunctionArn": "arn:aws:lambda:eu-central-1:604370441254:function:HelloWorld:$LATEST",
            "Runtime": "nodejs6.10",
            "Role": "arn:aws:iam::604370441254:role/basic-lambda-logging",
            "Handler": "index.helloworld",
            "CodeSize": 329,
            "Description": "",
            "Timeout": 3,
            "MemorySize": 128,
            "LastModified": "2017-11-16T16:27:38.108+0000",
            "CodeSha256": "ii2AmY6dB/YyUcQsSJFoWuEocq36gtpbbaTpcxMGJyc=",
            "Version": "$LATEST",
            "TracingConfig": {
                "Mode": "PassThrough"
            }
        }
    ]
}

- what is publishing? (Immutable snapshot)
  PublishVersion
   CreateFunction
 UpdateFunctionCode

The published versions are immutable. That is, you cannot change code or configuration information associated with a version.

Always use --publish arg

This is a qualified ARN, where the version number is a suffix. Published versions can have only qualified ARN.



- aliases
 - pointer to lambda version
 - promotion, rollback
 - event source mapping(?)

CreateAlias

UpdateAlias


- trafficing with aliases

aws lambda create-alias --name alias name --function-name function-name \
--function-version 1
--routing-config AdditionalVersionWeights={"2"=0.02}

You can point an alias to a maximum of two Lambda function versions.



- trafficing with weighted lambda

$ aws --version
aws-cli/1.14.2 Python/2.7.14 Darwin/16.7.0 botocore/1.8.6

$ aws lambda  create-alias  --function-name HelloDevcon --function-version 5 --name A_B_TEST --routing-config AdditionalVersionWeights={"4"=0.5}
{
    "FunctionVersion": "5",
    "Name": "A_B_TEST",
    "AliasArn": "arn:aws:lambda:eu-central-1:604370441254:function:HelloDevcon:A_B_TEST",
    "RoutingConfig": {
        "AdditionalVersionWeights": {
            "4": 0.5
        }
    },
    "Description": ""
}
dschmitz@schda-ambp2 in ~/dev/projects/lambda_demo_devcon/devcon-schedule-lambda/demo1_hellodevcon [master] (☁ tecco/eu-central-1)
$ aws lambda invoke --function-name arn:aws:lambda:eu-central-1:604370441254:function:HelloDevcon:A_B_TEST
usage: aws [options] <command> <subcommand> [<subcommand> ...] [parameters]
To see help text, you can run:

  aws help
  aws <command> help
  aws <command> <subcommand> help
aws: error: too few arguments
dschmitz@schda-ambp2 in ~/dev/projects/lambda_demo_devcon/devcon-schedule-lambda/demo1_hellodevcon [master] (☁ tecco/eu-central-1)
$ aws lambda invoke --function-name arn:aws:lambda:eu-central-1:604370441254:function:HelloDevcon:A_B_TEST out.txt
{
    "ExecutedVersion": "5",
    "StatusCode": 200
}
dschmitz@schda-ambp2 in ~/dev/projects/lambda_demo_devcon/devcon-schedule-lambda/demo1_hellodevcon [master] (☁ tecco/eu-central-1)
$ cat out.txt
"This is version B!"
dschmitz@schda-ambp2 in ~/dev/projects/lambda_demo_devcon/devcon-schedule-lambda/demo1_hellodevcon [master] (☁ tecco/eu-central-1)
$ aws lambda invoke --function-name arn:aws:lambda:eu-central-1:604370441254:function:HelloDevcon:A_B_TEST out.txt
{
    "ExecutedVersion": "4",
    "StatusCode": 200
}
dschmitz@schda-ambp2 in ~/dev/projects/lambda_demo_devcon/devcon-schedule-lambda/demo1_hellodevcon [master] (☁ tecco/eu-central-1)
$ aws lambda invoke --function-name arn:aws:lambda:eu-central-1:604370441254:function:HelloDevcon:A_B_TEST out.txt
{
    "ExecutedVersion": "5",
    "StatusCode": 200
}

```
/aws/lambda/HelloDevcon 2017/12/01/[4]ef5ef0246a7c4472a01caaf714ac777f START RequestId: 69034b77-d6a9-11e7-95aa-01f3d49bd15f Version: 4
/aws/lambda/HelloDevcon 2017/12/01/[4]ef5ef0246a7c4472a01caaf714ac777f 2017-12-01T15:07:56.059Z 69034b77-d6a9-11e7-95aa-01f3d49bd15f  Event is: {}
/aws/lambda/HelloDevcon 2017/12/01/[4]ef5ef0246a7c4472a01caaf714ac777f END RequestId: 69034b77-d6a9-11e7-95aa-01f3d49bd15f
/aws/lambda/HelloDevcon 2017/12/01/[4]ef5ef0246a7c4472a01caaf714ac777f REPORT RequestId: 69034b77-d6a9-11e7-95aa-01f3d49bd15f Duration: 47.27 ms  Billed Duration: 100 ms   Memory Size: 128 MB Max Memory Used: 20 MB
/aws/lambda/HelloDevcon 2017/12/01/[5]c102a268dd7b44faaa40dae14b9cfcf3 START RequestId: 6ac14f0d-d6a9-11e7-b4e8-7dc47c34f469 Version: 5
/aws/lambda/HelloDevcon 2017/12/01/[5]c102a268dd7b44faaa40dae14b9cfcf3 2017-12-01T15:07:58.731Z 6ac14f0d-d6a9-11e7-b4e8-7dc47c34f469  Event is: {}
/aws/lambda/HelloDevcon 2017/12/01/[5]c102a268dd7b44faaa40dae14b9cfcf3 END RequestId: 6ac14f0d-d6a9-11e7-b4e8-7dc47c34f469
/aws/lambda/HelloDevcon 2017/12/01/[5]c102a268dd7b44faaa40dae14b9cfcf3 REPORT RequestId: 6ac14f0d-d6a9-11e7-b4e8-7dc47c34f469 Duration: 0.48 ms Billed Duration: 100 ms   Memory Size: 128 MB Max Memory Used: 19 MB



Response payload (synchronous invocations) – Responses to synchronous function invocations include an x-amz-executed-version header to indicate which function version has been invoked.
```




http://docs.aws.amazon.com/lambda/latest/dg/versioning-intro.html
http://docs.aws.amazon.com/lambda/latest/dg/lambda-traffic-shifting-using-aliases.html
http://docs.aws.amazon.com/lambda/latest/dg/aliases-intro.html
